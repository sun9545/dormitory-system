# 周末离校请假单功能使用说明

## 📋 功能简介

周末离校请假单功能用于生成按公寓楼栋分类的周末请假Excel表单，适用于周末、节假日等多天连续请假的情况。

## ✨ 主要特性

1. **灵活的日期范围**：支持2-7天的请假日期选择
2. **按楼栋分sheet**：每个公寓楼生成一个独立工作表
3. **完整的表单格式**：包含表头、学生信息、请假状态、签字栏等
4. **动态日期列**：根据选择的日期范围自动生成对应列数
5. **智能周次计算**：自动计算学期周次（9月/3月第一个周一=第1周）

## 🚀 使用步骤

### 1. 进入请假管理页面

访问：`http://你的域名/leave.php`

### 2. 点击下载按钮

在页面右上角找到"下载请假信息"按钮，点击后会显示下拉菜单：
- **每日请假信息**：原有功能，下载单日请假数据
- **周末离校请假单**：新功能，下载周末请假表单

### 3. 选择日期范围

在弹出的模态框中：

#### 方式一：手动选择日期
- 选择"请假开始日期"
- 选择"请假结束日期"
- 系统会自动显示日期预览和周次

#### 方式二：快速选择
- **本周末(2天)**：自动选择本周五至周六
- **小长假(3天)**：自动选择本周五至周日
- **下周末(2天)**：自动选择下周五至周六

### 4. 生成Excel

点击"生成Excel"按钮，系统会：
1. 查询该时间段内的所有请假学生
2. 按公寓楼栋分组
3. 为每个楼栋生成一个sheet
4. 自动下载生成的Excel文件

## 📊 Excel表单结构

### 表头信息
- **标题**：周末离校请假单
- **周次和日期**：（第_X_周 YYYY年MM月DD日）
- **学院名称**：机电工程学院（固定）
- **公寓号**：动态显示楼号

### 数据列
| 列名 | 说明 | 示例 |
|------|------|------|
| 寝室号 | 区域+房间号 | A512, B323 |
| 学生姓名 | 学生真实姓名 | 张三 |
| 床位 | 床位号码 | 1, 2, 3, 4 |
| 请假时间 | 动态日期列 | 10月16日(周六), 10月17日(周日) |
| 备注 | 空白列 | - |

### 请假状态标记
- **请假**：显示 ✓
- **未请假**：留空

示例：
```
寝室号 | 姓名 | 床位 | 10月16日(周六) | 10月17日(周日) | 备注
A512  | 张三 |  1  |       ✓       |       ✓       |
B323  | 李四 |  2  |       ✓       |               |
```

### 底部签字栏
- **辅导员签字**：手签图片（如已上传）
- **分院领导签字**：空白待手签
- **分院盖章**：空白待盖章

## 🖼️ 辅导员签字图片设置

### 上传签字图片

1. **准备签字图片**
   - 格式：PNG（推荐透明背景）
   - 尺寸：300x100像素（推荐）
   - 文件大小：< 1MB

2. **上传到服务器**
   
   方式一：使用FTP上传
   ```
   上传到：/www/wwwroot/localhost/uploads/counselor_signature.png
   ```
   
   方式二：使用SSH上传
   ```bash
   scp 本地签字图片.png root@服务器IP:/www/wwwroot/localhost/uploads/counselor_signature.png
   ```
   
   方式三：直接放置
   ```bash
   # 在服务器上
   cd /www/wwwroot/localhost/uploads/
   # 将签字图片重命名为 counselor_signature.png
   ```

3. **设置权限**
   ```bash
   chmod 644 /www/wwwroot/localhost/uploads/counselor_signature.png
   chown www:www /www/wwwroot/localhost/uploads/counselor_signature.png
   ```

### 签字图片说明

- 如果存在签字图片，会自动插入到"辅导员签字"行
- 如果不存在，该位置留空，可手工签字
- 图片会自动缩放到合适高度（40px）

## 🔍 数据筛选规则

### 学生筛选
- 只包含在选定日期范围内有请假记录的学生
- 按寝室号排序（区域+房间号）

### 楼栋筛选
- 只生成有请假学生的楼栋sheet
- 楼栋按数字大小排序

### 请假状态判断
- 查询每个学生在每一天的请假记录
- 有请假记录 = ✓
- 无请假记录 = 空白

## 📁 文件命名规则

生成的文件名格式：
```
周末离校请假单_第X周_YYYYMMDD.xlsx
```

示例：
- `周末离校请假单_第7周_20251017.xlsx`
- `周末离校请假单_第12周_20251121.xlsx`

## ⚠️ 注意事项

1. **日期范围限制**：最多支持7天，适用于周末和小长假
2. **数据来源**：基于check_records表中的请假记录
3. **周次计算**：
   - 9月第一个周一 = 秋季学期第1周
   - 3月第一个周一 = 春季学期第1周
4. **空数据处理**：如果选定时间段内没有请假数据，会提示"该时间段内没有请假数据"
5. **打印设置**：自动设置为横向打印，自动调整宽度

## 🛠️ 故障排查

### 问题1：下载按钮没反应
**解决方案**：
- 检查是否选择了日期范围
- 打开浏览器控制台查看错误信息
- 检查网络连接

### 问题2：提示"该时间段内没有请假数据"
**解决方案**：
- 确认选择的日期范围内确实有请假记录
- 检查数据库中check_records表的数据
- 确认status字段为'请假'

### 问题3：签字图片不显示
**解决方案**：
- 检查图片路径：`/www/wwwroot/localhost/uploads/counselor_signature.png`
- 检查文件权限：`chmod 644`
- 检查文件格式：必须是PNG格式
- 检查文件大小：不要太大

### 问题4：Excel打开乱码
**解决方案**：
- 使用WPS或Microsoft Excel打开（推荐）
- 检查浏览器下载是否完整
- 重新生成并下载

### 问题5：周次计算不准确
**解决方案**：
- 检查服务器系统时间是否正确
- 确认学期开始时间设置（9月或3月第一个周一）
- 查看前端日期预览中显示的周次是否正确

## 📞 技术支持

如有问题，请联系系统管理员。

## 📝 更新日志

### v1.0 (2025-10-17)
- ✅ 初始版本发布
- ✅ 支持2-7天日期范围选择
- ✅ 按楼栋自动分sheet
- ✅ 动态日期列生成
- ✅ 周次自动计算
- ✅ 辅导员签字图片支持
- ✅ 完整的表单格式

